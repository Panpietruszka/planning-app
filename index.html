<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Architect Pro | Global Depth Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap');

        :root {
            --bg-midnight: #0a0a0a;
            --bg-panel: #141414;
            --accent-blue: #0071e3;
            --text-main: #f5f5f7;
            --text-dim: #86868b;
            --border-subtle: rgba(255, 255, 255, 0.08);
        }

        body {
            background-color: var(--bg-midnight);
            color: var(--text-main);
            font-family: 'Inter', -apple-system, sans-serif;
            -webkit-font-smoothing: antialiased;
            overflow: hidden;
        }

        .app-container {
            display: grid;
            grid-template-columns: 320px 1fr;
            height: 100vh;
        }

        .sidebar {
            background: var(--bg-panel);
            border-right: 1px solid var(--border-subtle);
            overflow-y: auto;
        }

        .workspace {
            background: var(--bg-midnight);
            overflow-y: auto;
            position: relative;
        }

        .glass-item {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            transition: all 0.2s ease;
        }

        .glass-item:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.15);
        }

        input::placeholder {
            color: #444;
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 10px;
        }
    </style>
</head>

<body>

    <div class="app-container">
        <aside class="sidebar flex flex-col">
            <div class="p-6 border-b border-white/[0.05]">
                <div class="flex items-center gap-2 mb-1">
                    <div class="w-3 h-3 rounded-full bg-blue-500"></div>
                    <h1 class="text-lg font-semibold tracking-tight">Architect Pro</h1>
                </div>
                <p class="text-[10px] text-gray-500 uppercase tracking-widest font-bold">Global Workspace</p>
            </div>

            <div class="p-4 flex-1">
                <button
                    onclick="document.getElementById('new-project-input-wrap').classList.remove('hidden'); document.getElementById('new-project-name').focus();"
                    class="w-full py-2 mb-4 bg-white text-black text-sm font-medium rounded-lg hover:bg-gray-200 transition-all flex items-center justify-center gap-2">
                    <span>+</span> New Project
                </button>

                <div id="new-project-input-wrap" class="hidden mb-6 px-2">
                    <input id="new-project-name" type="text" placeholder="Project name + Enter"
                        class="w-full bg-black/40 border border-blue-500/50 rounded p-2 text-xs text-white outline-none"
                        onkeydown="if(event.key==='Enter') window.addNewProject(this.value); if(event.key==='Escape') this.parentElement.classList.add('hidden');">
                </div>

                <nav id="project-nav" class="space-y-1">
                    <div class="text-xs text-gray-600 italic px-2">Synchronizing with cloud...</div>
                </nav>
            </div>

            <div class="p-4 border-t border-white/[0.05] flex justify-between items-center">
                <div id="auth-status" class="text-[10px] font-mono text-gray-500">Connecting...</div>
                <div id="status-dot" class="w-2 h-2 rounded-full bg-yellow-500 animate-pulse"></div>
            </div>
        </aside>

        <main class="workspace p-8 lg:p-12">
            <div id="active-project-view" class="max-w-4xl mx-auto">
                <div class="text-center mt-20 text-gray-600">
                    <svg class="mx-auto mb-4 opacity-20" width="64" height="64" fill="none" stroke="currentColor"
                        viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1"
                            d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10">
                        </path>
                    </svg>
                    <p class="text-lg">Select or create a project to begin.</p>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { initializeFirestore, collection, doc, addDoc, onSnapshot, updateDoc, deleteDoc, serverTimestamp, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBvYHO1sYbPw35VRai37By4sqz0OKnml_0",
            authDomain: "architect-pro-839a5.firebaseapp.com",
            projectId: "architect-pro-839a5",
            storageBucket: "architect-pro-839a5.firebasestorage.app",
            messagingSenderId: "970538126376",
            appId: "1:970538126376:web:1d41594e31f0f9c19c391d",
            measurementId: "G-T3FR5WGQT2"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = initializeFirestore(app, { experimentalForceLongPolling: true, useFetchStreams: false });
        const COLLECTION_NAME = 'global_projects';

        let projects = [];
        let activeProjectId = null;

        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('auth-status').innerText = `NODE_ACTIVE: ${user.uid.substring(0, 6)}`;
                document.getElementById('status-dot').classList.replace('bg-yellow-500', 'bg-green-500');
                setupListeners();
            }
        });

        signInAnonymously(auth).catch(err => console.error("Auth error:", err));

        const setupListeners = () => {
            onSnapshot(collection(db, COLLECTION_NAME), (snapshot) => {
                projects = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderSidebar();
                if (activeProjectId) renderWorkspace();
            });
        };

        // --- FUNKCJE LOGICZNE ---

        window.addNewProject = async (name) => {
            if (!name.trim()) return;
            try {
                const docRef = await addDoc(collection(db, COLLECTION_NAME), {
                    name, branches: [], createdAt: serverTimestamp()
                });
                activeProjectId = docRef.id;
                document.getElementById('new-project-input-wrap').classList.add('hidden');
                document.getElementById('new-project-name').value = '';
            } catch (err) { console.error(err); }
        };

        window.addBranch = async (projectId, name) => {
            if (!name || !name.trim()) return;
            try {
                await updateDoc(doc(db, COLLECTION_NAME, projectId), {
                    branches: arrayUnion({ id: crypto.randomUUID(), name, sections: []})
                });

                const inputWrap = document.getElementById(`branch-in-${projectId}`);
                if (inputWrap) inputWrap.classList.add('hidden');
            } catch (err) {
                console.error("Error adding branch:", err);
            }
        };

        window.saveInlineSection = async (projectId, branchId, name) => {
            if (!name.trim()) return;
            const project = projects.find(p => p.id === projectId);
            const updatedBranches = project.branches.map(b =>
                b.id === branchId ? { ...b, sections: [...b.sections, { id: crypto.randomUUID(), name, items: [] }] } : b
            );
            await updateDoc(doc(db, COLLECTION_NAME, projectId), { branches: updatedBranches });
        };

        window.saveInlineItem = async (projectId, branchId, sectionId, content) => {
            if (!content.trim()) return;
            const project = projects.find(p => p.id === projectId);
            const updatedBranches = project.branches.map(b => {
                if (b.id === branchId) {
                    const updatedSections = b.sections.map(s =>
                        s.id === sectionId ? { ...s, items: [...s.items, { id: crypto.randomUUID(), content }] } : s
                    );
                    return { ...b, sections: updatedSections };
                }
                return b;
            });
            await updateDoc(doc(db, COLLECTION_NAME, projectId), { branches: updatedBranches });
        };

        window.deleteProject = async (id) => {
            if (confirm("Delete global project?")) {
                await deleteDoc(doc(db, COLLECTION_NAME, id));
                if (activeProjectId === id) activeProjectId = null;
            }
        };

        window.setActive = (id) => { activeProjectId = id; renderSidebar(); renderWorkspace(); };

        window.showInput = (id) => {
            const el = document.getElementById(id);
            el.classList.remove('hidden');
            el.querySelector('input').focus();
        };

        // --- RENDEROWANIE ---

        const renderSidebar = () => {
            const nav = document.getElementById('project-nav');
            nav.innerHTML = projects.map(p => `
                <div onclick="window.setActive('${p.id}')" class="group flex justify-between items-center px-3 py-2 rounded-lg cursor-pointer transition-colors ${activeProjectId === p.id ? 'bg-blue-600/20 text-blue-400 border border-blue-500/30' : 'hover:bg-white/[0.03] text-gray-400'}">
                    <span class="text-sm font-medium truncate">${p.name}</span>
                    <button onclick="event.stopPropagation(); window.deleteProject('${p.id}')" class="opacity-0 group-hover:opacity-100 text-xs hover:text-red-500 transition-opacity"> &times; </button>
                </div>
            `).join('');
        };

        const renderWorkspace = () => {
            const view = document.getElementById('active-project-view');
            const project = projects.find(p => p.id === activeProjectId);
            if (!project) return;

            view.innerHTML = `
                <header class="flex justify-between items-end mb-12">
                    <div>
                        <h2 class="text-3xl font-bold tracking-tight">${project.name}</h2>
                        <p class="text-gray-500 text-sm">Real-time Cloud Sync</p>
                    </div>
                    <button onclick="window.showInput('branch-in-${project.id}')" 
                        class="px-5 py-2.5 bg-white text-black rounded-full text-xs font-bold hover:bg-gray-200 transition-all shadow-lg">
                        + New Branch
                    </button>
                </header>

                <div id="branch-in-${project.id}" class="hidden mb-12 animate-in fade-in duration-300">
                    <div class="glass-item p-1 border-blue-500/50 bg-blue-500/5">
                        <input type="text" placeholder="Type branch name and press Enter..." 
                            class="w-full bg-transparent px-6 py-4 text-lg text-white outline-none placeholder:text-gray-600" 
                            onkeydown="if(event.key==='Enter') window.addBranch('${project.id}', this.value); if(event.key==='Escape') this.parentElement.parentElement.classList.add('hidden');">
                    </div>
                    <p class="text-[10px] text-gray-500 mt-2 ml-2 uppercase tracking-widest">Press ESC to cancel</p>
                </div>
                <div class="space-y-12">
                    ${project.branches.map(branch => `
                        <div class="branch-container">
                            <div class="flex items-center gap-4 mb-6">
                                <h3 class="text-lg font-semibold text-gray-300 uppercase tracking-widest text-[11px] bg-white/5 px-3 py-1 rounded border border-white/10">${branch.name}</h3>
                                <div class="h-[1px] flex-1 bg-white/[0.05]"></div>
                                <button onclick="window.showInput('sec-in-${branch.id}')" class="text-[10px] font-bold text-blue-500 hover:underline">+ SECTION</button>
                            </div>

                            <div id="sec-in-${branch.id}" class="hidden mb-4 pl-4">
                                <input type="text" placeholder="Section name + Enter" class="bg-transparent border-b border-blue-500 outline-none text-sm text-white pb-1 w-64"
                                    onkeydown="if(event.key==='Enter') window.saveInlineSection('${project.id}', '${branch.id}', this.value)">
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pl-4">
                                ${branch.sections.map(section => `
                                    <div class="glass-item p-5">
                                        <div class="flex justify-between items-center mb-4">
                                            <h4 class="font-medium text-sm text-gray-200">${section.name}</h4>
                                            <button onclick="window.showInput('item-in-${section.id}')" class="text-[10px] text-gray-500 hover:text-white">+ ITEM</button>
                                        </div>
                                        <ul class="space-y-3 mb-4">
                                            ${section.items.map(item => `
                                                <li class="flex items-start gap-3 text-xs text-gray-400 bg-black/20 p-2 rounded border border-white/[0.02]">
                                                    <span class="mt-1.5 w-1 h-1 rounded-full bg-blue-500"></span>
                                                    ${item.content}
                                                </li>
                                            `).join('')}
                                        </ul>
                                        <div id="item-in-${section.id}" class="hidden">
                                            <input type="text" placeholder="Task + Enter" class="w-full bg-black/40 border border-blue-500/30 rounded p-2 text-xs text-white outline-none focus:border-blue-500"
                                                onkeydown="if(event.key==='Enter') window.saveInlineItem('${project.id}', '${branch.id}', '${section.id}', this.value)">
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        };
    </script>
</body>

</html>
